<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>AISKU Sample</title>
    <link rel="stylesheet" href="style/style.css"/>
    <script type="text/javascript">
      var connectionString = "YOUR_CONNECTION_STRING";
    </script>

    <!-- use this section for snippet Initialization -->
    <!-- <script type="text/javascript">!function(T,l,y){var S=T.location,k="script",D="instrumentationKey",C="ingestionendpoint",I="disableExceptionTracking",E="ai.device.",b="toLowerCase",w="crossOrigin",N="POST",e="appInsightsSDK",t=y.name||"appInsights";(y.name||T[e])&&(T[e]=t);var n=T[t]||function(d){var g=!1,f=!1,m={initialize:!0,queue:[],sv:"5",version:2,config:d};function v(e,t){var n={},a="Browser";return n[E+"id"]=a[b](),n[E+"type"]=a,n["ai.operation.name"]=S&&S.pathname||"_unknown_",n["ai.internal.sdkVersion"]="javascript:snippet_"+(m.sv||m.version),{time:function(){var e=new Date;function t(e){var t=""+e;return 1===t.length&&(t="0"+t),t}return e.getUTCFullYear()+"-"+t(1+e.getUTCMonth())+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+((e.getUTCMilliseconds()/1e3).toFixed(3)+"").slice(2,5)+"Z"}(),iKey:e,name:"Microsoft.ApplicationInsights."+e.replace(/-/g,"")+"."+t,sampleRate:100,tags:n,data:{baseData:{ver:2}}}}var h=d.url||y.src;if(h){function a(e){var t,n,a,i,r,o,s,c,u,p,l;g=!0,m.queue=[],f||(f=!0,t=h,s=function(){var e={},t=d.connectionString;if(t)for(var n=t.split(";"),a=0;a<n.length;a++){var i=n[a].split("=");2===i.length&&(e[i[0][b]()]=i[1])}if(!e[C]){var r=e.endpointsuffix,o=r?e.location:null;e[C]="https://"+(o?o+".":"")+"dc."+(r||"services.visualstudio.com")}return e}(),c=s[D]||d[D]||"",u=s[C],p=u?u+"/v2/track":d.endpointUrl,(l=[]).push((n="SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)",a=t,i=p,(o=(r=v(c,"Exception")).data).baseType="ExceptionData",o.baseData.exceptions=[{typeName:"SDKLoadFailed",message:n.replace(/\./g,"-"),hasFullStack:!1,stack:n+"\nSnippet failed to load ["+a+"] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: "+(S&&S.pathname||"_unknown_")+"\nEndpoint: "+i,parsedStack:[]}],r)),l.push(function(e,t,n,a){var i=v(c,"Message"),r=i.data;r.baseType="MessageData";var o=r.baseData;return o.message='AI (Internal): 99 message:"'+("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) ("+n+")").replace(/\"/g,"")+'"',o.properties={endpoint:a},i}(0,0,t,p)),function(e,t){if(JSON){var n=T.fetch;if(n&&!y.useXhr)n(t,{method:N,body:JSON.stringify(e),mode:"cors"});else if(XMLHttpRequest){var a=new XMLHttpRequest;a.open(N,t),a.setRequestHeader("Content-type","application/json"),a.send(JSON.stringify(e))}}}(l,p))}function i(e,t){f||setTimeout(function(){!t&&m.core||a()},500)}var e=function(){var n=l.createElement(k);n.src=h;var e=y[w];return!e&&""!==e||"undefined"==n[w]||(n[w]=e),n.onload=i,n.onerror=a,n.onreadystatechange=function(e,t){"loaded"!==n.readyState&&"complete"!==n.readyState||i(0,t)},n}();y.ld<0?l.getElementsByTagName("head")[0].appendChild(e):setTimeout(function(){l.getElementsByTagName(k)[0].parentNode.appendChild(e)},y.ld||0)}try{m.cookie=l.cookie}catch(p){}function t(e){for(;e.length;)!function(t){m[t]=function(){var e=arguments;g||m.queue.push(function(){m[t].apply(m,e)})}}(e.pop())}var n="track",r="TrackPage",o="TrackEvent";t([n+"Event",n+"PageView",n+"Exception",n+"Trace",n+"DependencyData",n+"Metric",n+"PageViewPerformance","start"+r,"stop"+r,"start"+o,"stop"+o,"addTelemetryInitializer","setAuthenticatedUserContext","clearAuthenticatedUserContext","flush"]),m.SeverityLevel={Verbose:0,Information:1,Warning:2,Error:3,Critical:4};var s=(d.extensionConfig||{}).ApplicationInsightsAnalytics||{};if(!0!==d[I]&&!0!==s[I]){var c="onerror";t(["_"+c]);var u=T[c];T[c]=function(e,t,n,a,i){var r=u&&u(e,t,n,a,i);return!0!==r&&m["_"+c]({message:e,url:t,lineNumber:n,columnNumber:a,error:i}),r},d.autoExceptionInstrumented=!0}return m}(y.cfg);function a(){y.onInit&&y.onInit(n)}(T[t]=n).queue&&0===n.queue.length?(n.queue.push(a),n.trackPageView({})):a()}(window,document,{
        src: "https://js.monitor.azure.com/scripts/b/ai.2.min.js", // The SDK URL Source for the CDN
        crossOrigin: "anonymous", // When supplied this will add the provided value as the cross origin attribute on the script tag
        cfg: { // Application Insights Configuration
          connectionString: connectionString
        }});
    </script> -->
    
  </head>
  <body>
    <h1>Microsoft Application Insights JavaScript SDK - AISKU</h1>
    <!-- this script is for local build testing -->
    <script src="../../AISKU/dist/es5/applicationinsights-web.js"></script>
    <script>
      let appInsights = new Microsoft.ApplicationInsights.ApplicationInsights({ config: {connectionString: "InstrumentationKey=key123", disableInstrumentationKeyValidation: true}});
      appInsights.loadAppInsights();
      window.appInsights = appInsights;
    </script>
    <script src="./browser/es5/aisku-example-index.gbl.js"></script>
    <script>
      async function init() {
          appInsights.trackEvent({ name: "testEvent" });

          let str = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam commodo non felis a aliquet. Praesent a felis congue, volutpat nibh sit amet, ultricies purus. Aenean nisl augue, condimentum at elementum sit amet, suscipit sed tortor. Curabitur dapibus eu ipsum id tristique. Phasellus hendrerit in eros sit amet mollis. Praesent commodo mollis rhoncus. Vivamus tempor ligula nisi, consequat venenatis nisi ultrices at.Nunc nec nibh molestie, sagittis lectus sit amet, facilisis ipsum. Morbi pretium, nisl non suscipit dapibus, mauris nulla sollicitudin lectus, a egestas mauris turpis quis magna. Nulla sit amet vehicula libero. Donec quis risus cursus, varius sapien vitae, tincidunt nibh. Sed molestie aliquet ultricies. Nam ac erat laoreet, pellentesque arcu ut, maximus neque. Proin dictum egestas faucibus. Maecenas sed accumsan lorem. Mauris molestie elit eget ultrices ornare. Vestibulum ante sem, pretium et nibh a, eleifend fermentum ipsum. Ut egestas blandit magna ut gravida. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus condimentum luctus justo sed aliquam. Orci varius natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Vestibulum et sapien ipsum. Aenean tristique rhoncus orci, eget pretium arcu auctor nec.Morbi at dictum ipsum. Vestibulum elit arcu, laoreet vel suscipit nec, pharetra nec tellus. Cras nec tellus ut tellus consequat auctor. Nulla non malesuada lacus. Donec sed aliquet magna, at pharetra risus. Aliquam aliquet elit sit amet auctor pellentesque. Sed rhoncus justo nulla, quis finibus dolor feugiat ut. Fusce vitae tincidunt eros. Nulla urna enim, dictum vel velit semper, porta vehicula metus. Vivamus dictum nibh lectus, nec sodales ligula pharetra vel. Phasellus turpis nibh, volutpat sed felis eleifend, suscipit aliquam magna. Etiam pharetra volutpat ligula ut commodo. Mauris at dolor vitae purus porta sollicitudin a at justo. Quisque magna risus, consectetur nec posuere quis, euismod a magna. Sed ut purus accumsan, pharetra est at, interdum risus. Duis eget tincidunt nibh, nec condimentum velit.onec rutrum nisl quis iaculis iaculis. Mauris sodales vestibulum metus. Maecenas enim nibh, molestie sit amet libero vitae, eleifend consequat sem. Sed a dui quis eros pharetra semper. Fusce erat lorem, cursus non nisl ac, vestibulum laoreet nisl. Pellentesque blandit purus mi, ac lacinia felis semper in. Maecenas facilisis, dolor sit amet ullamcorper dignissim, elit nisi finibus odio, in tempus ante mauris ut libero. Suspendisse auctor eros augue, eu commodo ipsum fermentum at. Cras dignissim felis non augue ullamcorper sagittis. Vestibulum ut pellentesque tortor, vitae pellentesque ligula. Maecenas sit amet luctus lectus. Etiam laoreet velit mi, eget vulputate dolor varius euulla at risus non sapien eleifend hendrerit ac vitae mauris. Quisque semper, velit in sagittis vulputate, nisi diam placerat felis, id facilisis nisi diam nec nisl. Proin suscipit volutpat luctus. Integer sagittis congue risus ut aliquet. Integer tincidunt gravida pharetra. Maecenas commodo finibus orci gravida tincidunt. Mauris ac lorem accumsan, varius odio a, auctor lacus. Vestibulum nisl ligula, volutpat ut elit et, ultrices placerat quam. Morbi sodales lacus quam, vitae vulputate orci blandit sed. Sed non iaculis turpis, ut hendrerit nisl. Aenean imperdiet orci quis nisi placerat tempus. Duis sit amet placerat eros. Nulla faucibus eu orci ac luctus. Suspendisse vestibulum sed quam et varius. Suspendisse sagittis dolor libero, fringilla aliquet elit pharetra sit amet.";

          async function compress(str) {
              // Convert the string to a byte stream.
              const stream = new Blob([str]).stream();

              // Create a compressed stream.
              const compressedStream = stream.pipeThrough(
                  new CompressionStream("gzip")
              );

              // Read all the bytes from this stream.
              const chunks = [];
              for await (const chunk of compressedStream) {
                  chunks.push(chunk);
                  console.log("chunk", chunk)
              }

              // Concatenate Uint8Arrays into a single Uint8Array
              const length = chunks.reduce((sum, chunk) => sum + chunk.length, 0);
              const result = new Uint8Array(length);
              let offset = 0;
              for (const chunk of chunks) {
                  result.set(chunk, offset);
                  offset += chunk.length;
              }

              // Convert the result to a binary string
              return result;
              // return result.reduce((data, byte) => data + String.fromCharCode(byte), '');
          }

          // let compressedStr = await compress(str);

          appInsights.trackEvent({ name: "test2", properties: { str } });
          appInsights.trackPageView({ name: "testPageView" });



          async function decompressUint8Array(compressedStr) {
    // Create a ReadableStream from the Uint8Array
    const readableStream = new ReadableStream({
        start(controller) {
            controller.enqueue(compressedStr);
            controller.close();
        }
    });

    // Create a DecompressionStream (gzip in this example, adjust as needed)
    const decompressionStream = new DecompressionStream('gzip');

    // Pipe the ReadableStream through the DecompressionStream
    const decompressedStream = readableStream.pipeThrough(decompressionStream);

    // Convert the decompressed stream to a string
    const reader = decompressedStream.getReader();
    let decompressedData = '';

    try {
        while (true) {
            const { done, value } = await reader.read();
            if (done) {
                break;
            }
            decompressedData += new TextDecoder().decode(value);
        }
    } finally {
        reader.releaseLock();
    }

    return decompressedData;
}

// Usage example
// async function exampleUsage() {
//     try {
//         let decompressedData = await decompressUint8Array(compressedStr);
//         console.log('Decompressed data:', decompressedData);
//     } catch (error) {
//         console.error('Error decompressing data:', error);
//     }
// }

// exampleUsage();
        }
      init();
  </script>
  </body>
</html>